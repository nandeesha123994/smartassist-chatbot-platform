{% extends 'base.html' %}

{% block title %}Chat - {{ project.name }}{% endblock %}

{% block content %}
<div class="chat-wrapper"
  style="padding: 2rem 1rem; display: flex; justify-content: center; min-height: calc(100vh - 120px); align-items: flex-start;">
  <div class="card chat-card"
    style="width: 100%; max-width: 900px; height: 750px; display: flex; flex-direction: column; overflow: hidden; padding: 0;">
    <header class="chat-header"
      style="padding: 1.5rem 2rem; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.1);">
      <div>
        <h3 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
          <i data-lucide="bot" style="color: var(--accent-color);"></i>
          {{ project.name }}
        </h3>
        <p class="subtitle" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.2rem;">Powered by
          Mistral 7B Engine</p>
      </div>
      <a href="{% url 'project_detail' project.id %}"
        style="color: var(--text-secondary); text-decoration: none; font-size: 0.85rem; display: flex; align-items: center; gap: 0.4rem;">
        <i data-lucide="settings" style="width: 16px;"></i> Configure
      </a>
    </header>

    <div class="chat-history custom-scrollbar" id="chat-history"
      style="flex: 1; overflow-y: auto; padding: 2rem; display: flex; flex-direction: column; gap: 1.25rem; background: rgba(0,0,0,0.05);">
      {% for entry in history %}
      <div class="chat-entry {% if entry.role == 'user' %}user{% else %}bot{% endif %}"
        style="display: flex; gap: 1rem; max-width: 85%; {% if entry.role == 'user' %}align-self: flex-end; flex-direction: row-reverse;{% endif %}">
        <div class="avatar"
          style="width: 32px; height: 32px; border-radius: 50%; background: {% if entry.role == 'user' %}var(--accent-color){% else %}rgba(255,255,255,0.1){% endif %}; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600; flex-shrink: 0; border: 1px solid var(--glass-border);">
          {% if entry.role == 'user' %}<i data-lucide="user" style="width: 16px;"></i>{% else %}<i data-lucide="bot"
            style="width: 16px;"></i>{% endif %}
        </div>
        <div class="bubble"
          style="padding: 0.85rem 1.25rem; border-radius: 1.25rem; font-size: 0.95rem; line-height: 1.5; {% if entry.role == 'user' %}background: var(--accent-color); color: white; box-shadow: 0 4px 15px var(--accent-glow);{% else %}background: rgba(255,255,255,0.07); border: 1px solid var(--glass-border);{% endif %}">
          {{ entry.content|linebreaksbr }}
        </div>
      </div>
      {% endfor %}
    </div>

    <form method="POST" class="chat-input-area"
      style="padding: 1.5rem 2rem; border-top: 1px solid var(--glass-border); background: rgba(0,0,0,0.1);">
      {% csrf_token %}
      <div class="input-group"
        style="display: flex; gap: 1rem; background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 3rem; border: 1px solid var(--glass-border);">
        <input type="text" name="message" placeholder="Send a message to {{ project.name }}..." required
          autocomplete="off"
          style="flex: 1; background: transparent; border: none; margin-bottom: 0; padding-left: 1.5rem; height: 45px;"
          autofocus>
        <button type="submit" class="btn-primary"
          style="width: 45px; height: 45px; border-radius: 50%; padding: 0; min-width: 45px; box-shadow: none;">
          <i data-lucide="send" style="width: 20px;"></i>
        </button>
      </div>
    </form>
  </div>
</div>

<style>
  #chat-history::-webkit-scrollbar {
    width: 6px;
  }

  .chat-entry {
    animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) both;
  }
</style>

<script>
  const historyBox = document.getElementById('chat-history');
  historyBox.scrollTop = historyBox.scrollHeight;

  // Handle auto-scroll on form submission
  document.querySelector('.chat-input-area').addEventListener('submit', function () {
    // Small delay to allow message to render if it was synchronous
    setTimeout(() => { historyBox.scrollTop = historyBox.scrollHeight; }, 50);
  });
</script>
{% endblock %}